<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Club Management Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #1a237e;
            --secondary-color: #0d47a1;
            --accent-color: #2196f3;
            --text-color: #333;
            --sidebar-width: 250px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: var(--sidebar-width);
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1rem;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .sidebar-header {
            padding: 1rem;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .profile-section {
            text-align: center;
            padding: 1rem 0;
        }

        .profile-image {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-bottom: 0.5rem;
            border: 3px solid rgba(255, 255, 255, 0.2);
        }

        .nav-item {
            margin: 0.5rem 0;
        }

        .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .nav-link.active {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
        }

        /* Main Content Styles */
        .main-content {
            margin-left: var(--sidebar-width);
            padding: 2rem;
            transition: all 0.3s ease;
        }

        /* Dashboard Cards */
        .dashboard-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        /* Tables */
        .table-container {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-top: 2rem;
        }

        .custom-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .custom-table th {
            background-color: #f8f9fa;
            padding: 1rem;
            font-weight: 600;
            text-align: left;
            border-bottom: 2px solid #dee2e6;
        }

        .custom-table td {
            padding: 1rem;
            border-bottom: 1px solid #dee2e6;
            vertical-align: middle;
        }

        /* Buttons */
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(26, 35, 126, 0.2);
        }

        /* Modals */
        .modal-content {
            border-radius: 12px;
            border: none;
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 12px 12px 0 0;
        }

        .modal-body {
            padding: 2rem;
        }

        /* Forms */
        .form-control {
            border-radius: 8px;
            padding: 0.75rem 1rem;
            border: 1px solid #dee2e6;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(26, 35, 126, 0.25);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .main-content.shifted {
                margin-left: var(--sidebar-width);
            }
        }

        /* Additional Styles */
        .expense-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        /* Income Overview Card Styles */
        .stat-card {
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease;
        }

        .stat-card:hover .stat-icon {
            transform: scale(1.1);
        }

        .stat-card .progress {
            background: rgba(255, 255, 255, 0.2);
            margin-top: 0.5rem;
        }

        .stat-card .progress-bar {
            transition: width 1s ease;
        }

        .stat-card h3 {
            font-size: 1.75rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .stat-card small {
            opacity: 0.8;
        }

        /* Add animation for the icons */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .stat-icon i {
            animation: pulse 2s infinite;
        }

        /* Add gradient background to stat cards */
        .stat-card {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        }

        .stat-card:nth-child(2) {
            background: linear-gradient(135deg, #2e7d32, #43a047);
        }

        .stat-card:nth-child(3) {
            background: linear-gradient(135deg, #f57c00, #ff9800);
        }

        .stat-card:nth-child(4) {
            background: linear-gradient(135deg, #1565c0, #1976d2);
        }

        .expense-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .expense-amount {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .expense-category {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            background: rgba(26, 35, 126, 0.1);
            color: var(--primary-color);
        }

        .participant-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .participant-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid #dee2e6;
        }

        .participant-item:last-child {
            border-bottom: none;
        }

        .financial-chart {
            height: 300px;
            margin: 1rem 0;
        }

        .profile-modal .profile-image {
            width: 120px;
            height: 120px;
            margin: 0 auto 1rem;
        }

        .file-upload {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload:hover {
            border-color: var(--primary-color);
            background: rgba(26, 35, 126, 0.05);
        }

        .file-upload i {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h4>Club Management</h4>
        </div>
        <div class="profile-section">
            <img src="https://ui-avatars.com/api/?name=Shashank+Vispute&background=random" alt="Profile" class="profile-image">
            <h6 class="mt-2 mb-0">Shashank Vispute</h6>
            <small>Club Member</small>
        </div>
        <nav class="mt-4">
            <div class="nav-item">
                <a href="#dashboard" class="nav-link active" data-section="dashboard">
                    <i class="fas fa-home"></i> Dashboard
                </a>
            </div>
            <div class="nav-item">
                <a href="#events" class="nav-link" data-section="events">
                    <i class="fas fa-calendar-alt"></i> Event Management
                </a>
            </div>
            <div class="nav-item">
                <a href="#participants" class="nav-link" data-section="participants">
                    <i class="fas fa-users"></i> Participant Tracking
                </a>
            </div>
            <div class="nav-item">
                <a href="#finance" class="nav-link" data-section="finance">
                    <i class="fas fa-chart-line"></i> Financial Management
                </a>
            </div>
            <div class="nav-item mt-auto">
                <a href="#" class="nav-link" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Dashboard Section -->
        <section id="dashboard" class="content-section active">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Dashboard Overview</h2>
                <div class="d-flex gap-2">
                    <button class="btn btn-primary" id="createEventBtn" data-bs-toggle="modal" data-bs-target="#createEventModal">
                        <i class="fas fa-plus"></i> Create Event
                    </button>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="dashboard-card stat-card">
                        <h3 class="mb-3">Total Events</h3>
                        <div class="d-flex justify-content-between align-items-center">
                            <h2 id="totalEvents" class="mb-0">0</h2>
                            <i class="fas fa-calendar-alt fa-2x"></i>
                        </div>
                        <small id="newEvents" class="text-white-50">0 this month</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="dashboard-card stat-card">
                        <h3 class="mb-3">Total Participants</h3>
                        <div class="d-flex justify-content-between align-items-center">
                            <h2 id="totalParticipants" class="mb-0">0</h2>
                            <i class="fas fa-users fa-2x"></i>
                        </div>
                        <small id="newParticipants" class="text-white-50">0 this month</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="dashboard-card stat-card">
                        <h3 class="mb-3">Total Revenue</h3>
                        <div class="d-flex justify-content-between align-items-center">
                            <h2 id="totalRevenue" class="mb-0">₹0</h2>
                            <i class="fas fa-rupee-sign fa-2x"></i>
                        </div>
                        <small id="newRevenue" class="text-white-50">₹0 this month</small>
                    </div>
                </div>
            </div>

            <!-- Recent Events Table -->
            <div class="table-container mt-4">
                <h3 class="mb-4">Recent Events</h3>
                <table class="custom-table">
                    <thead>
                        <tr>
                            <th>Event Name</th>
                            <th>Date</th>
                            <th>Participants</th>
                            <th>Budget</th>
                            <th>Money Collected</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="eventsTableBody">
                        <!-- Events will be dynamically loaded here -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Event Management Section -->
        <section id="events" class="content-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Event Management</h2>
            </div>
            <div class="table-container">
                <table class="custom-table">
                    <thead>
                        <tr>
                            <th>Event Name</th>
                            <th>Date</th>
                            <th>Participants</th>
                            <th>Budget</th>
                            <th>Money Collected</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="eventsTableBody">
                        <!-- Events will be dynamically loaded here -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Participant Tracking Section -->
        <section id="participants" class="content-section">
            <h2 class="mb-4">Participant Tracking</h2>
            <div class="row">
                <div class="col-md-4">
                    <div class="dashboard-card">
                        <h3>Select Event</h3>
                        <select class="form-select mb-3" id="eventSelect">
                            <option value="">Choose an event...</option>
                        </select>
                        <button class="btn btn-primary w-100" onclick="addParticipant()">
                            <i class="fas fa-user-plus"></i> Add Participant
                        </button>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="dashboard-card">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3>Participants List</h3>
                            <div>
                                <button class="btn btn-success me-2" onclick="exportParticipantsList()">
                                <i class="fas fa-file-export"></i> Export
                            </button>
                                <button class="btn btn-info" onclick="refreshParticipants()">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                        </div>
                        <div class="participant-list" id="participantsList">
                            <!-- Participants will be dynamically loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Financial Management Section -->
        <section id="finance" class="content-section">
            <h2 class="mb-4">Financial Management</h2>
            
            <!-- Income Overview -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="dashboard-card">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3>Income Overview</h3>
                            <div class="d-flex gap-2">
                                <select class="form-select w-auto" id="incomeEventFilter">
                                    <option value="all">All Events</option>
                                </select>
                                <button class="btn btn-primary" onclick="refreshIncomeData()">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                                <button class="btn btn-success" id="addIncomeBtn">
                                    <i class="fas fa-plus"></i> Add Income
                                </button>
                            </div>
                        </div>
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="stat-card p-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h5 class="mb-0">Total Income</h5>
                                        <div class="stat-icon">
                                            <i class="fas fa-money-bill-wave fa-2x"></i>
                                        </div>
                                    </div>
                                    <h3 id="totalIncome" class="mb-1">₹0</h3>
                                    <div class="progress" style="height: 4px;">
                                        <div class="progress-bar bg-success" role="progressbar" style="width: 75%"></div>
                                    </div>
                                    <small class="text-white-50">All Events</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card p-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h5 class="mb-0">Completed Payments</h5>
                                        <div class="stat-icon">
                                            <i class="fas fa-check-circle fa-2x"></i>
                                        </div>
                                    </div>
                                    <h3 id="completedPayments" class="mb-1">0</h3>
                                    <div class="progress" style="height: 4px;">
                                        <div class="progress-bar bg-success" role="progressbar" style="width: 85%"></div>
                                    </div>
                                    <small class="text-white-50">Successful Transactions</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card p-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h5 class="mb-0">Pending Payments</h5>
                                        <div class="stat-icon">
                                            <i class="fas fa-clock fa-2x"></i>
                                        </div>
                                    </div>
                                    <h3 id="pendingPayments" class="mb-1">0</h3>
                                    <div class="progress" style="height: 4px;">
                                        <div class="progress-bar bg-warning" role="progressbar" style="width: 25%"></div>
                                    </div>
                                    <small class="text-white-50">Awaiting Confirmation</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card p-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h5 class="mb-0">Collection Rate</h5>
                                        <div class="stat-icon">
                                            <i class="fas fa-chart-line fa-2x"></i>
                                        </div>
                                    </div>
                                    <h3 id="collectionRate" class="mb-1">0%</h3>
                                    <div class="progress" style="height: 4px;">
                                        <div class="progress-bar bg-info" role="progressbar" style="width: 65%"></div>
                                    </div>
                                    <small class="text-white-50">Of Potential Income</small>
                                </div>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Event</th>
                                        <th>Total Registrations</th>
                                        <th>Total Income</th>
                                        <th>Payment Status</th>
                                        <th>Details</th>
                                    </tr>
                                </thead>
                                <tbody id="incomeTableBody">
                                    <!-- Income data will be dynamically loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Expense Overview -->
            <div class="row">
                <div class="col-md-6">
                    <div class="dashboard-card">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3>Event-wise Expenses</h3>
                            <button class="btn btn-primary" id="addExpenseBtn">
                                <i class="fas fa-plus"></i> Add Expense
                            </button>
                        </div>
                        <div class="mt-4">
                            <h4>Expense Breakdown</h4>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Event</th>
                                            <th>Budget</th>
                                            <th>Expenses</th>
                                            <th>Balance</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="expenseBreakdown">
                                        <!-- Expense breakdown will be dynamically loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="dashboard-card">
                        <h3>Expense Distribution</h3>
                        <div class="mt-4">
                            <h4>Category-wise Expenses</h4>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Category</th>
                                            <th>Amount</th>
                                            <th>Percentage</th>
                                        </tr>
                                    </thead>
                                    <tbody id="categoryExpenses">
                                        <!-- Category expenses will be dynamically loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Expense Tracking Section -->
        <section id="expenses" class="content-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Expense Tracking</h2>
                <button class="btn btn-primary" id="addExpenseBtn">
                    <i class="fas fa-plus"></i> Add Expense
                </button>
            </div>
            <div class="row">
                <div class="col-md-4">
                    <div class="dashboard-card">
                        <h3>Total Expenses</h3>
                        <h2 class="text-primary" id="totalExpenses">₹0</h2>
                        <div class="mt-3">
                            <h4>By Category</h4>
                            <ul class="list-unstyled" id="expenseCategories">
                                <!-- Categories will be dynamically loaded here -->
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="dashboard-card">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3>Event-wise Expenses</h3>
                            <select class="form-select w-auto" id="eventExpenseFilter">
                                    <option value="all">All Events</option>
                                </select>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Event</th>
                                        <th>Category</th>
                                        <th>Amount</th>
                                        <th>Date</th>
                                        <th>Description</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="eventExpensesList">
                                    <!-- Event expenses will be dynamically loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Update Add Participant Modal -->
        <div class="modal fade" id="addParticipantModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add New Participant</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="addParticipantForm">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Student Name</label>
                                    <input type="text" class="form-control" name="name" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Student ID</label>
                                    <input type="text" class="form-control" name="studentId" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-control" name="email" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Phone</label>
                                    <input type="tel" class="form-control" name="phone" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Department</label>
                                    <select class="form-select" name="department" required>
                                        <option value="">Select Department</option>
                                        <option value="Artificial Intelligence">Artificial Intelligence</option>
                                        <option value="Data Science">Data Science</option>
                                        <option value="Chemical Engineering">Chemical Engineering</option>
                                        <option value="Civil Engineering">Civil Engineering</option>
                                        <option value="Computer Engineering">Computer Engineering</option>
                                        <option value="Computer Science and Design">Computer Science and Design</option>
                                        <option value="Electrical Engineering">Electrical Engineering</option>
                                        <option value="Electronics & Telecommunication">Electronics & Telecommunication</option>
                                        <option value="Information Technology">Information Technology</option>
                                        <option value="Mechanical Engineering">Mechanical Engineering</option>
                                        <option value="Robotics and Automation Engineering">Robotics and Automation Engineering</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Year</label>
                                    <select class="form-select" name="year" required>
                                        <option value="">Select Year</option>
                                        <option value="1st Year">1st Year</option>
                                        <option value="2nd Year">2nd Year</option>
                                        <option value="3rd Year">3rd Year</option>
                                        <option value="4th Year">4th Year</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Registration Status</label>
                                    <select class="form-select" name="status" required>
                                        <option value="pending">Pending</option>
                                        <option value="confirmed">Confirmed</option>
                                        <option value="cancelled">Cancelled</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Payment Status</label>
                                    <select class="form-select" name="paymentStatus" required>
                                        <option value="pending">Pending</option>
                                        <option value="completed">Completed</option>
                                        <option value="failed">Failed</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Payment Method</label>
                                    <select class="form-select" name="paymentMethod">
                                        <option value="">Select Payment Method</option>
                                        <option value="online">Online</option>
                                        <option value="card">Card</option>
                                        <option value="cash">Cash</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Payment Reference</label>
                                    <input type="text" class="form-control" name="paymentReference">
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="saveParticipant()">Add Participant</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Event Modal -->
    <div class="modal fade" id="createEventModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Event</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createEventForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Event Name</label>
                                <input type="text" class="form-control" name="eventName" required placeholder="Enter event name">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Category</label>
                                <select class="form-select" name="category" required>
                                    <option value="">Select Category</option>
                                    <option value="technical">Technical</option>
                                    <option value="cultural">Cultural</option>
                                    <option value="business">Business</option>
                                    <option value="sports">Sports</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Date</label>
                                <input type="date" class="form-control" name="date" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Time</label>
                                <input type="time" class="form-control" name="time" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Location</label>
                                <input type="text" class="form-control" name="location" required placeholder="Enter venue">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Maximum Participants</label>
                                <input type="number" class="form-control" name="maxParticipants" required placeholder="Enter max participants">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Entry Fee</label>
                                <input type="number" class="form-control" name="entryFee" required placeholder="Enter entry fee">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Budget</label>
                                <input type="number" class="form-control" name="budget" required placeholder="Enter budget amount">
                            </div>
                            <div class="col-12">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" name="description" rows="3" placeholder="Enter event description"></textarea>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Event Photo</label>
                                <div class="file-upload" id="eventPhotoUpload">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    <p>Drag & drop or click to upload event photo</p>
                                    <small class="text-muted">Supported formats: JPG, PNG (Max size: 2MB)</small>
                                    <input type="file" class="d-none" id="eventPhotoInput" accept="image/jpeg,image/png">
                                </div>
                                <div id="eventPhotoPreview" class="mt-2 d-none">
                                    <img src="" alt="Event Photo Preview" class="img-thumbnail" style="max-height: 200px;">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveEvent()">Create Event</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Expense Modal -->
    <div class="modal fade" id="addExpenseModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Expense</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addExpenseForm">
                        <div class="mb-3">
                            <label class="form-label">Event</label>
                            <select class="form-select" name="event" required id="expenseEventSelect">
                                <option value="">Select Event</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Amount</label>
                            <input type="number" class="form-control" name="amount" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Category</label>
                            <select class="form-select" name="category" required>
                                <option value="">Select Category</option>
                                <option value="Venue & Equipment">Venue & Equipment</option>
                                <option value="Marketing & Promotion">Marketing & Promotion</option>
                                <option value="Food & Beverages">Food & Beverages</option>
                                <option value="Prizes & Certificates">Prizes & Certificates</option>
                                <option value="Miscellaneous">Miscellaneous</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-control" name="date" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" name="description" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Proof of Expense</label>
                            <div class="file-upload" id="expenseProofUpload">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <p>Drag & drop or click to upload</p>
                                <small class="text-muted">Supported formats: PDF, JPG, PNG</small>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveExpense()">Save Expense</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="modal fade" id="profileModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">User Profile</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center">
                        <img src="https://ui-avatars.com/api/?name=Shashank+Vispute&background=random" alt="Profile" class="profile-image">
                        <h4>Shashank Vispute</h4>
                        <p class="text-muted">Club Member</p>
                    </div>
                    <form id="profileForm" class="mt-4">
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" value="shashankvispute100@gmail.com" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Phone</label>
                            <input type="tel" class="form-control" value="+91 1234567890">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Department</label>
                            <input type="text" class="form-control" value="Computer Science">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Year</label>
                            <input type="text" class="form-control" value="3rd Year">
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Update Profile</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap and other scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- Add the data store script before other scripts -->
    <script src="js/data-store.js"></script>
    <script>
        // Initialize data store listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Listen for event changes
            DataStore.addListener('events', updateEventDisplay);
            DataStore.addListener('registrations', updateRegistrationDisplay);
            DataStore.addListener('expenses', updateExpenseDisplay);
            DataStore.addListener('income', updateDashboardStats);
            
            // Listen for income changes to update dashboard stats
            DataStore.addListener('events', updateDashboardStats);
            DataStore.addListener('registrations', updateDashboardStats);

            // Initial data load
            updateEventDisplay(DataStore.events);
            updateRegistrationDisplay(DataStore.registrations);
            updateExpenseDisplay(DataStore.expenses);
            
            // Update dashboard stats with real-time data
            updateDashboardStats();
        });

        // Update event display
        function updateEventDisplay(events) {
            const tbody = document.getElementById('eventsTableBody');
            tbody.innerHTML = events.map(event => {
                const stats = DataStore.calculateEventStats(event._id);
                return `
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                ${event.photo ? `
                                    <img src="${event.photo}" alt="${event.title}" class="rounded me-2" style="width: 40px; height: 40px; object-fit: cover;">
                                ` : `
                                    <div class="rounded me-2" style="width: 40px; height: 40px; background: #f0f0f0; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-calendar-alt text-muted"></i>
                </div>
                                `}
                                <span>${event.title}</span>
                            </div>
                        </td>
                        <td>${new Date(event.date).toLocaleDateString()}</td>
                        <td>${stats.confirmedParticipants}/${stats.totalCapacity}</td>
                        <td>₹${event.budget}</td>
                        <td>
                            <div class="d-flex flex-column">
                                <span class="mb-1">₹${stats.moneyCollected}</span>
                                <div class="progress" style="height: 5px;">
                                    <div class="progress-bar bg-success" role="progressbar" 
                                         style="width: ${stats.collectionPercentage}%" 
                                         aria-valuenow="${stats.collectionPercentage}" 
                                         aria-valuemin="0" 
                                         aria-valuemax="100">
                            </div>
                            </div>
                                <small class="text-muted">${stats.collectionPercentage.toFixed(1)}% collected</small>
                            </div>
                        </td>
                        <td><span class="badge bg-success">${event.status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-primary me-2" onclick="editEvent('${event._id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteEvent('${event._id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Update registration display
        function updateRegistrationDisplay(registrations) {
            const eventSelect = document.getElementById('eventSelect');
            const selectedEvent = eventSelect.value;
            
            if (selectedEvent) {
                const eventRegistrations = registrations.filter(r => r.eventId === selectedEvent);
                populateParticipantsList(eventRegistrations);
            }
        }

        // Update expense display
        function updateExpenseDisplay(expenses) {
            const eventFilter = document.getElementById('eventExpenseFilter');
            const selectedEvent = eventFilter.value;
            
            const filteredExpenses = selectedEvent === 'all' 
                ? expenses 
                : expenses.filter(e => e.eventId === selectedEvent);
            
            populateEventExpenses(filteredExpenses);
            updateTotalExpenses(expenses);
            updateExpenseCategories(expenses);
        }

        // Save event function
        function saveEvent() {
            const form = document.getElementById('createEventForm');
            const formData = new FormData(form);
            const photoFile = document.getElementById('eventPhotoInput').files[0];
            
            // Create new event object
            const newEvent = {
                _id: (DataStore.events.length + 1).toString(),
                title: formData.get('eventName'),
                description: formData.get('description'),
                date: formData.get('date'),
                time: formData.get('time'),
                location: formData.get('location'),
                capacity: `0/${formData.get('maxParticipants')}`,
                entryFee: parseInt(formData.get('entryFee')),
                category: formData.get('category'),
                budget: parseInt(formData.get('budget')),
                status: 'Active',
                photo: null
            };

            // Handle photo upload
            if (photoFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    newEvent.photo = e.target.result;
                    DataStore.addEvent(newEvent);
                    completeEventSave();
                };
                reader.readAsDataURL(photoFile);
            } else {
                DataStore.addEvent(newEvent);
                completeEventSave();
            }
        }

        // Delete event function
        function deleteEvent(eventId) {
            if (confirm('Are you sure you want to delete this event?')) {
                DataStore.deleteEvent(eventId);
                showToast('Event deleted successfully!', 'success');
            }
        }

        // Save registration function
        function saveRegistration() {
            const form = document.getElementById('addParticipantForm');
            const formData = new FormData(form);
            const eventId = document.getElementById('eventSelect').value;
            
            const newRegistration = {
                _id: (DataStore.registrations.length + 1).toString(),
                eventId: eventId,
                student: {
                    name: formData.get('name'),
                    studentId: formData.get('studentId'),
                    email: formData.get('email'),
                    phone: formData.get('phone'),
                    department: formData.get('department'),
                    year: formData.get('year')
                },
                registrationDate: new Date().toISOString(),
                status: formData.get('status'),
                paymentStatus: formData.get('paymentStatus'),
                paymentMethod: formData.get('paymentMethod'),
                paymentReference: formData.get('paymentReference'),
                amount: DataStore.getEventById(eventId).entryFee
            };

            DataStore.addRegistration(newRegistration);
            showToast('Participant added successfully!', 'success');
        }

        // Save expense function
        function saveExpense() {
            const form = document.getElementById('addExpenseForm');
            const formData = new FormData(form);
            
            const newExpense = {
                _id: 'E' + (DataStore.expenses.length + 1),
                eventId: formData.get('event'),
                category: formData.get('category'),
                amount: parseInt(formData.get('amount')),
                date: formData.get('date'),
                description: formData.get('description') || 'No description provided'
            };

            DataStore.addExpense(newExpense);
            showToast('Expense added successfully!', 'success');
        }

        // Save settings function - removed

        // Check login status
        document.addEventListener('DOMContentLoaded', function() {
            const isLoggedIn = localStorage.getItem('clubMemberLoggedIn');
            if (!isLoggedIn) {
                window.location.href = 'club-member-login.html';
            }
        });

        // Navigation
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', function(e) {
                if (this.id === 'logoutBtn') {
                    e.preventDefault();
                    handleLogout();
                    return;
                }

                const section = this.getAttribute('data-section');
                document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                document.getElementById(section).classList.add('active');

                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                this.classList.add('active');
            });
        });

        // Create Event Modal
        const createEventBtn = document.getElementById('createEventBtn');
        const createEventModal = new bootstrap.Modal(document.getElementById('createEventModal'));

        createEventBtn.addEventListener('click', () => {
            createEventModal.show();
        });

        // Event data from index.html and main.js
        const mockEvents = [
            {
                _id: '1',
                title: 'Web Development Workshop',
                description: 'Learn the fundamentals of web development with HTML, CSS, and JavaScript.',
                date: '2025-05-15',
                time: '2:00 PM',
                location: 'Tech Club',
                capacity: '0/50',
                entryFee: 500,
                category: 'technical',
                budget: 25000,
                status: 'Active'
            },
            {
                _id: '2',
                title: 'Annual Music Concert',
                description: 'Join us for a night of music, featuring performances from talented students.',
                date: '2025-05-20',
                time: '5:30 PM',
                location: 'Music Club',
                capacity: '0/75',
                entryFee: 750,
                category: 'cultural',
                budget: 35000,
                status: 'Active'
            },
            {
                _id: '3',
                title: 'Entrepreneurship Summit',
                description: 'Network with successful entrepreneurs and learn about startup opportunities.',
                date: '2025-06-05',
                time: '10:00 AM',
                location: 'E-Cell',
                capacity: '0/100',
                entryFee: 1000,
                category: 'business',
                budget: 45000,
                status: 'Active'
            }
        ];

        // Function to calculate total money collected for an event
        function calculateMoneyCollected(eventId) {
            const event = mockEvents.find(e => e._id === eventId);
            if (!event) return 0;

            // Count confirmed participants with completed payment
            const confirmedParticipants = mockRegistrations.filter(reg => 
                reg.eventId === eventId && 
                reg.status === 'confirmed' &&
                reg.paymentStatus === 'completed'
            ).length;

            // Calculate total money collected
            return confirmedParticipants * event.entryFee;
        }

        // Function to update event capacity
        function updateEventCapacity(eventId) {
            const event = mockEvents.find(e => e._id === eventId);
            if (!event) return;

            // Count confirmed participants
            const confirmedParticipants = mockRegistrations.filter(reg => 
                reg.eventId === eventId && 
                reg.status === 'confirmed'
            ).length;

            const maxParticipants = parseInt(event.capacity.split('/')[1]);
            event.capacity = `${confirmedParticipants}/${maxParticipants}`;
        }

        // Function to populate events table
        function populateEventsTable() {
            const tbody = document.getElementById('eventsTableBody');
            tbody.innerHTML = mockEvents.map(event => {
                const moneyCollected = calculateMoneyCollected(event._id);
                const totalCapacity = parseInt(event.capacity.split('/')[1]);
                const maxPossibleCollection = totalCapacity * event.entryFee;
                const collectionPercentage = maxPossibleCollection > 0 ? (moneyCollected / maxPossibleCollection) * 100 : 0;

                // Get confirmed participants count
                const confirmedParticipants = mockRegistrations.filter(reg => 
                    reg.eventId === event._id && 
                    reg.status === 'confirmed'
                ).length;

                return `
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                ${event.photo ? `
                                    <img src="${event.photo}" alt="${event.title}" class="rounded me-2" style="width: 40px; height: 40px; object-fit: cover;">
                                ` : `
                                    <div class="rounded me-2" style="width: 40px; height: 40px; background: #f0f0f0; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-calendar-alt text-muted"></i>
                </div>
                                `}
                                <span>${event.title}</span>
                            </div>
                        </td>
                        <td>${new Date(event.date).toLocaleDateString()}</td>
                        <td>${confirmedParticipants}/${totalCapacity}</td>
                        <td>₹${event.budget}</td>
                        <td>
                            <div class="d-flex flex-column">
                                <span class="mb-1">₹${moneyCollected}</span>
                                <div class="progress" style="height: 5px;">
                                    <div class="progress-bar bg-success" role="progressbar" 
                                         style="width: ${collectionPercentage}%" 
                                         aria-valuenow="${collectionPercentage}" 
                                         aria-valuemin="0" 
                                         aria-valuemax="100">
                            </div>
                            </div>
                                <small class="text-muted">${collectionPercentage.toFixed(1)}% collected</small>
                            </div>
                        </td>
                        <td><span class="badge bg-success">${event.status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-primary me-2" onclick="editEvent('${event._id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteEvent('${event._id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Function to save new event
        function saveEvent() {
            const form = document.getElementById('createEventForm');
            const formData = new FormData(form);
            const photoFile = document.getElementById('eventPhotoInput').files[0];
            
            // Create new event object
            const newEvent = {
                _id: (mockEvents.length + 1).toString(),
                title: formData.get('eventName'),
                description: formData.get('description'),
                date: formData.get('date'),
                time: formData.get('time'),
                location: formData.get('location'),
                capacity: `0/${formData.get('maxParticipants')}`,
                entryFee: parseInt(formData.get('entryFee')),
                category: formData.get('category'),
                budget: parseInt(formData.get('budget')),
                status: 'Active',
                photo: null
            };

            // Handle photo upload
            if (photoFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    newEvent.photo = e.target.result;
                    completeEventSave(newEvent);
                };
                reader.readAsDataURL(photoFile);
            } else {
                completeEventSave(newEvent);
            }
        }

        function completeEventSave(event) {
            // Add to mockEvents array
            mockEvents.push(event);

            // Update tables
            populateEventsTable();
            updateIndexPageEvents();

            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('createEventModal'));
            modal.hide();

            // Reset form and photo preview
            document.getElementById('createEventForm').reset();
            document.getElementById('eventPhotoPreview').classList.add('d-none');
            document.getElementById('eventPhotoPreview').querySelector('img').src = '';

            // Show success message
            showToast('Event created successfully!', 'success');
        }

        // Function to update events on index.html
        function updateIndexPageEvents() {
            // Get events from localStorage or initialize empty array
            const events = JSON.parse(localStorage.getItem('events') || '[]');
            
            // Add new events that don't exist in localStorage
            mockEvents.forEach(event => {
                if (!events.some(e => e._id === event._id)) {
                    events.push({
                        _id: event._id,
                        title: event.title,
                        description: event.description,
                        date: event.date,
                        time: event.time,
                        location: event.location,
                        capacity: event.capacity,
                        entryFee: event.entryFee,
                        category: event.category,
                        status: event.status
                    });
                }
            });
            
            // Save updated events to localStorage
            localStorage.setItem('events', JSON.stringify(events));
        }

        // Function to edit event
        function editEvent(eventId) {
            const event = mockEvents.find(e => e._id === eventId);
            if (!event) return;

            // Populate form with event data
            const form = document.getElementById('createEventForm');
            form.querySelector('[name="eventName"]').value = event.title;
            form.querySelector('[name="date"]').value = event.date;
            form.querySelector('[name="time"]').value = event.time;
            form.querySelector('[name="location"]').value = event.location;
            form.querySelector('[name="maxParticipants"]').value = event.capacity.split('/')[1];
            form.querySelector('[name="budget"]').value = event.budget;
            form.querySelector('[name="description"]').value = event.description;
            form.querySelector('[name="category"]').value = event.category;

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('createEventModal'));
            modal.show();
        }

        // Function to delete event
        function deleteEvent(eventId) {
            if (confirm('Are you sure you want to delete this event?')) {
                const index = mockEvents.findIndex(e => e._id === eventId);
                if (index !== -1) {
                    // Remove event from mockEvents
                    mockEvents.splice(index, 1);
                    
                    // Update tables and localStorage
                    populateEventsTable();
                    updateIndexPageEvents();
                    
                    // Remove event from index.html events
                    const events = JSON.parse(localStorage.getItem('events') || '[]');
                    const updatedEvents = events.filter(e => e._id !== eventId);
                    localStorage.setItem('events', JSON.stringify(updatedEvents));
                    
                    showToast('Event deleted successfully!', 'success');
                }
            }
        }

        // Function to show toast notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            document.body.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            toast.addEventListener('hidden.bs.toast', () => toast.remove());
        }

        // Initialize tables when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Load events from localStorage
            const savedEvents = JSON.parse(localStorage.getItem('events') || '[]');
            savedEvents.forEach(event => {
                if (!mockEvents.some(e => e._id === event._id)) {
                    mockEvents.push(event);
                }
            });

            // Update tables
            populateEventsTable();
            
            // Initialize other components
            populateEventSelect();
            initializeFinancialCharts();
        });

        // Logout Function
        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('clubMemberLoggedIn');
                localStorage.removeItem('clubMemberEmail');
                window.location.href = 'club-member-login.html';
            }
        }

        // Initialize charts with real data
        function initializeFinancialCharts() {
            // Prepare data for charts
            const eventLabels = mockEvents.map(event => event.title);
            const budgets = mockEvents.map(event => event.budget);
            const collected = mockEvents.map(event => calculateMoneyCollected(event._id));
            
            // Get actual expenses from mockExpenses
            const expenses = mockEvents.map(event => {
                const eventExpenses = mockExpenses
                    .filter(expense => expense.eventId === event._id)
                    .reduce((sum, expense) => sum + expense.amount, 0);
                return eventExpenses || 0;
            });

            // Calculate category totals for expense tables
            const categoryTotals = {};
            mockExpenses.forEach(expense => {
                categoryTotals[expense.category] = (categoryTotals[expense.category] || 0) + expense.amount;
            });

            // Populate category expenses table
            const categoryExpenses = document.getElementById('categoryExpenses');
            const totalExpenses = Object.values(categoryTotals).reduce((a, b) => a + b, 0);
            
            categoryExpenses.innerHTML = Object.entries(categoryTotals).map(([category, amount]) => {
                const percentage = ((amount / totalExpenses) * 100).toFixed(1);
                return `
                    <tr>
                        <td>
                            <span class="badge rounded-pill" style="background-color: ${getCategoryColor(category)}">
                                ${category}
                            </span>
                        </td>
                        <td>₹${amount.toLocaleString()}</td>
                        <td>${percentage}%</td>
                    </tr>
                `;
            }).join('');

            // Populate expense breakdown table
            const expenseBreakdown = document.getElementById('expenseBreakdown');
            expenseBreakdown.innerHTML = mockEvents.map(event => {
                const eventExpenses = expenses[mockEvents.indexOf(event)];
                const balance = event.budget - eventExpenses;
                const status = balance >= 0 ? 'success' : 'danger';
                
                return `
                    <tr>
                        <td>${event.title}</td>
                        <td>₹${event.budget.toLocaleString()}</td>
                        <td>₹${eventExpenses.toLocaleString()}</td>
                        <td class="text-${status}">₹${balance.toLocaleString()}</td>
                        <td>
                            <span class="badge bg-${status}">
                                ${balance >= 0 ? 'Under Budget' : 'Over Budget'}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');

            // Populate collection summary table
            const collectionSummary = document.getElementById('collectionSummary');
            if (collectionSummary) {
                collectionSummary.innerHTML = mockEvents.map(event => {
                    const moneyCollected = calculateMoneyCollected(event._id);
                    const totalCapacity = parseInt(event.capacity.split('/')[1]);
                    const maxPossibleCollection = totalCapacity * event.entryFee;
                    const percentage = maxPossibleCollection > 0 ? (moneyCollected / maxPossibleCollection) * 100 : 0;
                    const status = percentage >= 80 ? 'success' : percentage >= 50 ? 'warning' : 'danger';
                    
                    return `
                        <tr>
                            <td>${event.title}</td>
                            <td>₹${maxPossibleCollection.toLocaleString()}</td>
                            <td>₹${moneyCollected.toLocaleString()}</td>
                            <td>${percentage.toFixed(1)}%</td>
                            <td>
                                <span class="badge bg-${status}">
                                    ${percentage >= 80 ? 'Excellent' : percentage >= 50 ? 'Good' : 'Needs Attention'}
                                </span>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
        }

        // Profile click handler
        document.querySelector('.profile-section').addEventListener('click', function() {
            const profileModal = new bootstrap.Modal(document.getElementById('profileModal'));
            profileModal.show();
        });

        // Add expense button handler
        document.getElementById('addExpenseBtn').addEventListener('click', function() {
            const addExpenseModal = new bootstrap.Modal(document.getElementById('addExpenseModal'));
            addExpenseModal.show();
        });

        // File upload handler
        document.getElementById('expenseProofUpload').addEventListener('click', function() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.pdf,.jpg,.jpeg,.png';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Handle file upload
                    console.log('File selected:', file.name);
                }
            };
            input.click();
        });

        // Save expense handler
        function saveExpense() {
            const form = document.getElementById('addExpenseForm');
            const formData = new FormData(form);
            
            // Validate form
            if (!formData.get('event') || !formData.get('amount') || !formData.get('category') || !formData.get('date')) {
                showToast('Please fill all required fields', 'warning');
                return;
            }
            
            const newExpense = {
                _id: 'E' + (mockExpenses.length + 1),
                eventId: formData.get('event'),
                category: formData.get('category'),
                amount: parseInt(formData.get('amount')),
                date: formData.get('date'),
                description: formData.get('description') || 'No description provided'
            };

            mockExpenses.push(newExpense);
            
            // Update UI
            updateTotalExpenses();
            updateExpenseCategories();
            populateEventExpenses(document.getElementById('eventExpenseFilter').value);
            
            // Update financial charts
            initializeFinancialCharts();
            
            // Close modal and reset form
            const addExpenseModal = bootstrap.Modal.getInstance(document.getElementById('addExpenseModal'));
            addExpenseModal.hide();
            form.reset();
            
            showToast('Expense added successfully!', 'success');
        }

        // Add this after the mockRegistrations array
        const mockRegistrations = [
            {
                _id: '101',
                student: { 
                    name: 'John Doe', 
                    studentId: 'ST12345', 
                    email: 'john@example.com',
                    phone: '+91 9876543210',
                    department: 'Computer Science',
                    year: '3rd Year'
                },
                eventId: '1',
                registrationDate: '2025-05-10T10:30:00',
                status: 'confirmed',
                paymentStatus: 'completed',
                paymentMethod: 'online',
                paymentReference: 'TXN123456',
                amount: 500
            },
            {
                _id: '102',
                student: { 
                    name: 'Jane Smith', 
                    studentId: 'ST12346', 
                    email: 'jane@example.com',
                    phone: '+91 9876543211',
                    department: 'Information Technology',
                    year: '2nd Year'
                },
                eventId: '1',
                registrationDate: '2025-05-11T14:20:00',
                status: 'pending',
                paymentStatus: 'pending',
                paymentMethod: '',
                paymentReference: '',
                amount: 500
            },
            {
                _id: '103',
                student: { 
                    name: 'Mike Johnson', 
                    studentId: 'ST12347', 
                    email: 'mike@example.com',
                    phone: '+91 9876543212',
                    department: 'Electronics',
                    year: '4th Year'
                },
                eventId: '2',
                registrationDate: '2025-05-12T09:15:00',
                status: 'confirmed',
                paymentStatus: 'failed',
                paymentMethod: 'card',
                paymentReference: 'FAILED123',
                amount: 750
            }
        ];

        // Function to populate event select dropdown
        function populateEventSelect() {
            const select = document.getElementById('eventSelect');
            select.innerHTML = '<option value="">Choose an event...</option>';
            
            mockEvents.forEach(event => {
                const option = document.createElement('option');
                option.value = event._id;
                option.textContent = event.title;
                select.appendChild(option);
            });
        }

        // Function to populate participants list
        function populateParticipantsList(participants) {
            const participantsList = document.getElementById('participantsList');
            
            if (participants.length === 0) {
                participantsList.innerHTML = '<p class="text-muted">No participants registered for this event.</p>';
                return;
            }

            participantsList.innerHTML = `
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Sr. No.</th>
                                <th>Student Details</th>
                                <th>Academic Info</th>
                                <th>Registration Details</th>
                                <th>Payment Details</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${participants.map((reg, index) => `
                                <tr class="${reg.status === 'pending' ? 'table-warning' : ''}">
                                    <td class="align-middle">${index + 1}</td>
                                    <td>
                                        <div class="d-flex flex-column">
                                            <strong>${reg.student.name}</strong>
                                            <small class="text-muted">
                                                <i class="fas fa-id-card"></i> ${reg.student.studentId}
                                            </small>
                                            <small class="text-muted">
                                                <i class="fas fa-envelope"></i> ${reg.student.email}
                                            </small>
                                            <small class="text-muted">
                                                <i class="fas fa-phone"></i> ${reg.student.phone}
                                            </small>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="d-flex flex-column">
                                            <small class="text-muted">
                                                <i class="fas fa-graduation-cap"></i> ${reg.student.department}
                                            </small>
                                            <small class="text-muted">
                                                <i class="fas fa-calendar"></i> ${reg.student.year}
                                            </small>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="d-flex flex-column">
                                            <small class="text-muted">
                                                <i class="fas fa-calendar-alt"></i> ${new Date(reg.registrationDate).toLocaleDateString()}
                                            </small>
                                            <span class="badge bg-${reg.status === 'confirmed' ? 'success' : reg.status === 'pending' ? 'warning' : 'danger'}">
                                                ${reg.status}
                                            </span>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="d-flex flex-column">
                                            <small class="text-muted">
                                                <i class="fas fa-rupee-sign"></i> ₹${reg.amount}
                                            </small>
                                            <span class="badge bg-${reg.paymentStatus === 'completed' ? 'success' : reg.paymentStatus === 'pending' ? 'warning' : 'danger'}">
                                                ${reg.paymentStatus}
                                            </span>
                                            ${reg.paymentMethod ? `<small class="text-muted"><i class="fas fa-credit-card"></i> ${reg.paymentMethod}</small>` : ''}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-primary" onclick="updateParticipantStatus('${reg._id}')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        <button class="btn btn-sm btn-danger" onclick="removeParticipant('${reg._id}')">
                                            <i class="fas fa-user-minus"></i>
                                        </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Function to add new participant
        function addParticipant() {
            const eventSelect = document.getElementById('eventSelect');
            if (!eventSelect.value) {
                showToast('Please select an event first', 'warning');
                return;
            }

            // Show add participant modal
            const modal = new bootstrap.Modal(document.getElementById('addParticipantModal'));
            modal.show();
        }

        // Function to remove participant
        function removeParticipant(participantId) {
            if (confirm('Are you sure you want to remove this participant?')) {
                // Remove from mockRegistrations array
                const index = mockRegistrations.findIndex(reg => reg._id === participantId);
                if (index !== -1) {
                    mockRegistrations.splice(index, 1);
                    updateParticipantDisplay();
                    showToast('Participant removed successfully!', 'success');
                }
            }
        }

        // Event listener for event selection
        document.getElementById('eventSelect').addEventListener('change', function() {
            updateParticipantDisplay();
        });

        // Initialize participant tracking when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Populate event select dropdown
            const eventSelect = document.getElementById('eventSelect');
            eventSelect.innerHTML = '<option value="">Choose an event...</option>';
            
            mockEvents.forEach(event => {
                const option = document.createElement('option');
                option.value = event._id;
                option.textContent = event.title;
                eventSelect.appendChild(option);
            });

            // Set up periodic refresh
            setInterval(() => {
                const selectedEvent = eventSelect.value;
                if (selectedEvent) {
                    updateParticipantDisplay();
                }
            }, 30000); // Refresh every 30 seconds
        });

        // Save participant handler
        function saveParticipant() {
            const form = document.getElementById('addParticipantForm');
            const eventId = document.getElementById('eventSelect').value;
            const event = mockEvents.find(e => e._id === eventId);
            
            if (!event) {
                showToast('Event not found', 'error');
                return;
            }

            const maxParticipants = parseInt(event.capacity.split('/')[1]);
            const confirmedParticipants = mockRegistrations.filter(reg => 
                reg.eventId === eventId && 
                reg.status === 'confirmed'
            ).length;
            
            if (confirmedParticipants >= maxParticipants) {
                showToast('Event has reached maximum participants', 'warning');
                return;
            }

            const participant = {
                _id: (mockRegistrations.length + 1).toString(),
                student: {
                    name: form.querySelector('input[name="name"]').value,
                    studentId: form.querySelector('input[name="studentId"]').value,
                    email: form.querySelector('input[name="email"]').value,
                    phone: form.querySelector('input[name="phone"]').value,
                    department: form.querySelector('select[name="department"]').value,
                    year: form.querySelector('select[name="year"]').value
                },
                eventId: eventId,
                registrationDate: new Date().toISOString(),
                status: form.querySelector('select[name="status"]').value,
                paymentStatus: form.querySelector('select[name="paymentStatus"]').value,
                paymentMethod: form.querySelector('select[name="paymentMethod"]').value,
                paymentReference: form.querySelector('input[name="paymentReference"]').value,
                amount: event.entryFee
            };

            mockRegistrations.push(participant);
            updateEventCapacity(eventId);
            updateParticipantDisplay();
            
            const addParticipantModal = bootstrap.Modal.getInstance(document.getElementById('addParticipantModal'));
            addParticipantModal.hide();
            showToast('Participant added successfully!', 'success');
        }

        // Function to export participants list as CSV
        function exportParticipantsList() {
            try {
                const eventSelect = document.getElementById('eventSelect');
                const eventId = eventSelect.value;
                
                if (!eventId) {
                    showToast('Please select an event first', 'warning');
                    return;
                }

                const event = mockEvents.find(e => e._id === eventId);
                if (!event) {
                    showToast('Event not found', 'error');
                    return;
                }

                const participants = mockRegistrations.filter(reg => reg.eventId === eventId);
                if (participants.length === 0) {
                    showToast('No participants found for this event', 'warning');
                    return;
                }

                // Create CSV content
                let csvContent = 'Event Details\n';
                csvContent += `Event Name,${event.title}\n`;
                csvContent += `Date,${new Date(event.date).toLocaleDateString()}\n`;
                csvContent += `Time,${event.time}\n`;
                csvContent += `Location,${event.location}\n`;
                csvContent += `Category,${event.category}\n`;
                csvContent += `Entry Fee,₹${event.entryFee}\n`;
                csvContent += `Budget,₹${event.budget}\n\n`;
                
                // Add headers for participant data
                csvContent += 'Student Name,Student ID,Email,Phone,Department,Year,Registration Date,Status,Payment Status,Payment Method,Payment Reference,Amount\n';
                
                // Add participant data
                participants.forEach(reg => {
                    csvContent += `${reg.student.name},${reg.student.studentId},${reg.student.email},${reg.student.phone},${reg.student.department},${reg.student.year},${new Date(reg.registrationDate).toLocaleString()},${reg.status},${reg.paymentStatus},${reg.paymentMethod || ''},${reg.paymentReference || ''},₹${reg.amount}\n`;
                });
                
                // Create a blob and download link
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                
                // Generate filename
                const fileName = `KKW_${event.title.replace(/\s+/g, '_')}_Participants_${new Date().toISOString().split('T')[0]}.csv`;
                link.download = fileName;
                
                // Trigger download
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // Show success message
                showToast('Participant list exported successfully!', 'success');
            } catch (error) {
                console.error('Error exporting participant list:', error);
                showToast('Error exporting participant list. Please try again.', 'error');
            }
        }

        // Helper function to convert string to ArrayBuffer
        function s2ab(s) {
            const buf = new ArrayBuffer(s.length);
            const view = new Uint8Array(buf);
            for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
            return buf;
        }

        // Add this after the mockEvents array
        const mockExpenses = [
            {
                _id: 'E1',
                eventId: '1',
                category: 'Venue & Equipment',
                amount: 7500,
                date: '2025-05-10',
                description: 'Venue booking and technical equipment rental'
            },
            {
                _id: 'E2',
                eventId: '1',
                category: 'Marketing & Promotion',
                amount: 5000,
                date: '2025-05-12',
                description: 'Social media marketing and posters'
            },
            {
                _id: 'E3',
                eventId: '2',
                category: 'Food & Beverages',
                amount: 5250,
                date: '2025-05-15',
                description: 'Refreshments for participants'
            },
            {
                _id: 'E4',
                eventId: '2',
                category: 'Prizes & Certificates',
                amount: 8000,
                date: '2025-05-18',
                description: 'Awards and participation certificates'
            },
            {
                _id: 'E5',
                eventId: '3',
                category: 'Venue & Equipment',
                amount: 12000,
                date: '2025-06-01',
                description: 'Conference hall booking and AV equipment'
            },
            {
                _id: 'E6',
                eventId: '3',
                category: 'Marketing & Promotion',
                amount: 7500,
                date: '2025-06-02',
                description: 'Digital marketing campaign and promotional materials'
            },
            {
                _id: 'E7',
                eventId: '1',
                category: 'Miscellaneous',
                amount: 3000,
                date: '2025-05-14',
                description: 'Transportation and logistics'
            }
        ];

        // Add these functions before the DOMContentLoaded event listener
        function populateEventExpenseFilter() {
            const filter = document.getElementById('eventExpenseFilter');
            filter.innerHTML = '<option value="all">All Events</option>';
            
            mockEvents.forEach(event => {
                const option = document.createElement('option');
                option.value = event._id;
                option.textContent = event.title;
                filter.appendChild(option);
            });
        }

        function updateTotalExpenses() {
            const total = mockExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            document.getElementById('totalExpenses').textContent = `₹${total.toLocaleString()}`;
        }

        function updateExpenseCategories() {
            const categories = {};
            mockExpenses.forEach(expense => {
                categories[expense.category] = (categories[expense.category] || 0) + expense.amount;
            });

            const categoriesList = document.getElementById('expenseCategories');
            categoriesList.innerHTML = Object.entries(categories).map(([category, amount]) => {
                const total = mockExpenses.reduce((sum, e) => sum + e.amount, 0);
                const percentage = (amount / total) * 100;
                return `
                    <li class="mb-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>${category}</span>
                            <span class="text-primary">₹${amount.toLocaleString()}</span>
                        </div>
                        <div class="progress" style="height: 4px;">
                            <div class="progress-bar bg-primary" role="progressbar" 
                                 style="width: ${percentage}%"
                                 aria-valuenow="${percentage}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                            </div>
                        </div>
                        <small class="text-muted">${percentage.toFixed(1)}% of total</small>
                    </li>
                `;
            }).join('');
        }

        function populateEventExpenses(eventId = 'all') {
            const expensesList = document.getElementById('eventExpensesList');
            const filteredExpenses = eventId === 'all' 
                ? mockExpenses 
                : mockExpenses.filter(expense => expense.eventId === eventId);

            if (filteredExpenses.length === 0) {
                expensesList.innerHTML = '<tr><td colspan="6" class="text-center">No expenses found</td></tr>';
                return;
            }

            expensesList.innerHTML = filteredExpenses.map(expense => {
                const event = mockEvents.find(e => e._id === expense.eventId);
                return `
                    <tr>
                        <td>${event ? event.title : 'Unknown Event'}</td>
                        <td>
                            <span class="badge rounded-pill" style="background-color: ${getCategoryColor(expense.category)}">
                                ${expense.category}
                            </span>
                        </td>
                        <td>₹${expense.amount.toLocaleString()}</td>
                        <td>${new Date(expense.date).toLocaleDateString()}</td>
                        <td>${expense.description}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deleteExpense('${expense._id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getCategoryColor(category) {
            const colorMap = {
                'Venue & Equipment': '#1a237e',
                'Marketing & Promotion': '#f44336',
                'Food & Beverages': '#2196f3',
                'Prizes & Certificates': '#4caf50',
                'Miscellaneous': '#ff9800'
            };
            return colorMap[category] || '#6c757d';
        }

        function deleteExpense(expenseId) {
            if (confirm('Are you sure you want to delete this expense?')) {
                const index = mockExpenses.findIndex(e => e._id === expenseId);
                if (index !== -1) {
                    mockExpenses.splice(index, 1);
                    
                    // Update UI
                    updateTotalExpenses();
                    updateExpenseCategories();
                    populateEventExpenses(document.getElementById('eventExpenseFilter').value);
                    
                    // Update financial charts
                    initializeFinancialCharts();
                    
                    showToast('Expense deleted successfully!', 'success');
                }
            }
        }

        // Function to populate expense event select
        function populateExpenseEventSelect() {
            const select = document.getElementById('expenseEventSelect');
            select.innerHTML = '<option value="">Select Event</option>';
            
            mockEvents.forEach(event => {
                const option = document.createElement('option');
                option.value = event._id;
                option.textContent = event.title;
                select.appendChild(option);
            });
        }

        // Update the DOMContentLoaded event listener
        document.addEventListener('DOMContentLoaded', function() {
            // Existing initialization code...
            populateEventSelect();
            populateEventsTable();
            
            // Initialize financial charts
            initializeFinancialCharts();
            
            // Initialize expense tracking
            populateEventExpenseFilter();
            populateExpenseEventSelect();
            updateTotalExpenses();
            updateExpenseCategories();
            populateEventExpenses();
            
            // Start checking for new registrations
            checkNewRegistrations();
            
            // Set up periodic check for new registrations
            setInterval(checkNewRegistrations, 5000); // Check every 5 seconds
            
            // Add event listener for expense filter
            document.getElementById('eventExpenseFilter').addEventListener('change', function() {
                populateEventExpenses(this.value);
            });
            
            // Add event listener for expense tab
            document.querySelector('a[href="#expenses"]').addEventListener('click', function() {
                // Update expense tracking data when tab is clicked
                updateTotalExpenses();
                updateExpenseCategories();
                populateEventExpenses();
            });
            
            // Add event listener for participants tab
            document.querySelector('a[href="#participants"]').addEventListener('click', function() {
                // Check for new registrations when participants tab is clicked
                checkNewRegistrations();
            });
            
            // Add expenses tab to navigation if it doesn't exist
            if (!document.querySelector('a[href="#expenses"]')) {
                const financeNavItem = document.querySelector('a[href="#finance"]').parentNode;
                const expensesNavItem = document.createElement('div');
                expensesNavItem.className = 'nav-item';
                expensesNavItem.innerHTML = `
                    <a href="#expenses" class="nav-link" data-section="expenses">
                        <i class="fas fa-receipt"></i> Expense Tracking
                    </a>
                `;
                financeNavItem.after(expensesNavItem);
            }
        });

        // Add this after the mockRegistrations array
        // Function to check for new registrations
        function checkNewRegistrations() {
            // Get registrations from localStorage (set by index.html)
            const newRegistrations = JSON.parse(localStorage.getItem('newRegistrations') || '[]');
            
            if (newRegistrations.length > 0) {
                // Add new registrations to mockRegistrations
                newRegistrations.forEach(registration => {
                    // Check if registration already exists
                    const exists = mockRegistrations.some(reg => 
                        reg.student.studentId === registration.student.studentId && 
                        reg.eventId === registration.eventId
                    );
                    
                    if (!exists) {
                        mockRegistrations.push(registration);
                        showRegistrationSuccess(registration);
                    }
                });
                
                // Clear new registrations from localStorage
                localStorage.removeItem('newRegistrations');
                
                // Update UI
                updateParticipantDisplay();
            }
        }

        // Function to show registration success message
        function showRegistrationSuccess(registration) {
            const event = mockEvents.find(e => e._id === registration.eventId);
            const successMessage = `
                <div class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="fas fa-check-circle me-2"></i>
                            New Registration: ${registration.student.name} for ${event.title}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            const toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            toastContainer.innerHTML = successMessage;
            document.body.appendChild(toastContainer);
            
            const toast = new bootstrap.Toast(toastContainer.querySelector('.toast'));
            toast.show();
            
            // Remove toast container after animation
            toastContainer.addEventListener('hidden.bs.toast', () => {
                toastContainer.remove();
            });
        }

        // Function to update participant display
        function updateParticipantDisplay() {
            const eventSelect = document.getElementById('eventSelect');
            const eventId = eventSelect.value;
            
            if (!eventId) {
                const participantsList = document.getElementById('participantsList');
                participantsList.innerHTML = '<p class="text-muted">Please select an event to view participants.</p>';
                return;
            }

            // Filter participants for the selected event
            const participants = mockRegistrations.filter(reg => reg.eventId === eventId);
                populateParticipantsList(participants);
        }

        // Add event photo upload handler
        document.getElementById('eventPhotoUpload').addEventListener('click', function() {
            document.getElementById('eventPhotoInput').click();
        });

        document.getElementById('eventPhotoInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 2 * 1024 * 1024) {
                    showToast('File size should be less than 2MB', 'warning');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('eventPhotoPreview');
                    preview.classList.remove('d-none');
                    preview.querySelector('img').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // Function to refresh participants list
        function refreshParticipants() {
            const selectedEvent = document.getElementById('eventSelect').value;
            if (selectedEvent) {
                updateParticipantDisplay();
                showToast('Participants list refreshed!', 'success');
            } else {
                showToast('Please select an event first', 'warning');
            }
        }

        // Function to update participant status
        function updateParticipantStatus(participantId) {
            const participant = DataStore.getParticipantById(participantId);
            if (!participant) return;

            const newStatus = participant.status === 'confirmed' ? 'pending' : 'confirmed';
            if (DataStore.updateParticipantStatus(participantId, newStatus)) {
                updateParticipantDisplay();
                showToast(`Participant status updated to ${newStatus}!`, 'success');
            }
        }

        // Function to update income display
        function updateIncomeDisplay() {
            const eventFilter = document.getElementById('incomeEventFilter');
            const selectedEventId = eventFilter.value;
            
            // Filter events if necessary
            let events = DataStore.events;
            if (selectedEventId !== 'all') {
                events = events.filter(event => event._id === selectedEventId);
            }
            
            if (events.length === 0) {
                document.getElementById('totalIncome').textContent = '₹0';
                document.getElementById('completedPayments').textContent = '0';
                document.getElementById('pendingPayments').textContent = '0';
                document.getElementById('collectionRate').textContent = '0%';
                document.getElementById('incomeTableBody').innerHTML = '<tr><td colspan="5" class="text-center">No income data available</td></tr>';
                return;
            }
            
            // Calculate income statistics
            let totalIncome = 0;
            let completedPayments = 0;
            let pendingPayments = 0;
            let potentialIncome = 0;
            
            events.forEach(event => {
                // Get all income for this event
                const eventIncome = DataStore.getEventIncome(event._id);
                
                // Calculate totals
                eventIncome.forEach(income => {
                    if (income.status === 'completed') {
                        totalIncome += income.amount;
                        completedPayments++;
                    } else if (income.status === 'pending') {
                        pendingPayments++;
                    }
                });
                
                // Calculate potential income based on event capacity and entry fee
                const capacity = parseInt(event.capacity.split('/')[1] || 0);
                potentialIncome += capacity * event.entryFee;
            });
            
            // Update summary cards
            document.getElementById('totalIncome').textContent = `₹${totalIncome.toLocaleString()}`;
            document.getElementById('completedPayments').textContent = completedPayments.toString();
            document.getElementById('pendingPayments').textContent = pendingPayments.toString();
            
            // Calculate collection rate
            const collectionRate = potentialIncome > 0 ? (totalIncome / potentialIncome) * 100 : 0;
            document.getElementById('collectionRate').textContent = `${collectionRate.toFixed(1)}%`;
            
            // Update progress bars to reflect real data
            document.querySelector('#totalIncome').closest('.stat-card').querySelector('.progress-bar').style.width = `${Math.min(100, collectionRate)}%`;
            document.querySelector('#completedPayments').closest('.stat-card').querySelector('.progress-bar').style.width = `${completedPayments > 0 ? Math.min(100, (completedPayments / (completedPayments + pendingPayments)) * 100) : 0}%`;
            document.querySelector('#pendingPayments').closest('.stat-card').querySelector('.progress-bar').style.width = `${pendingPayments > 0 ? Math.min(100, (pendingPayments / (completedPayments + pendingPayments)) * 100) : 0}%`;
            document.querySelector('#collectionRate').closest('.stat-card').querySelector('.progress-bar').style.width = `${Math.min(100, collectionRate)}%`;
            
            // Update income table
            const incomeTableBody = document.getElementById('incomeTableBody');
            incomeTableBody.innerHTML = events.map(event => {
                const eventIncome = DataStore.getEventIncome(event._id);
                const totalRegistrations = DataStore.registrations.filter(r => r.eventId === event._id).length;
                const totalEventIncome = eventIncome.reduce((sum, i) => sum + i.amount, 0);
                const completedCount = eventIncome.filter(i => i.status === 'completed').length;
                const pendingCount = eventIncome.filter(i => i.status === 'pending').length;
                
                // Calculate payment status percentage
                const paymentStatusClass = completedCount > pendingCount ? 'success' : 'warning';
                const paymentStatusPercentage = totalRegistrations > 0 ? 
                    Math.round((completedCount / (completedCount + pendingCount)) * 100) : 0;
                
                return `
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="event-icon me-2">
                                <i class="fas fa-calendar-day"></i>
                            </div>
                            <div>
                                <h6 class="mb-0">${event.title}</h6>
                                <small class="text-white-50">${new Date(event.date).toLocaleDateString()}</small>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="badge bg-primary">${totalRegistrations}</span>
                    </td>
                    <td>₹${totalEventIncome.toLocaleString()}</td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="progress me-2" style="height: 5px; width: 60px;">
                                <div class="progress-bar bg-${paymentStatusClass}" role="progressbar" style="width: ${paymentStatusPercentage}%"></div>
                            </div>
                            <span>${paymentStatusPercentage}% Completed</span>
                        </div>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewIncomeDetails('${event._id}')">
                            <i class="fas fa-eye"></i> View
                        </button>
                    </td>
                </tr>
                `;
            }).join('');
        }

        // Function to view income details
        function viewIncomeDetails(eventId) {
            const event = DataStore.events.find(e => e._id === eventId);
            const income = DataStore.getEventIncome(eventId);
            
            const modal = new bootstrap.Modal(document.getElementById('incomeDetailsModal'));
            const modalBody = document.getElementById('incomeDetailsBody');
            
            // Calculate total income for this event
            const totalEventIncome = income.reduce((sum, i) => sum + i.amount, 0);
            const completedIncome = income.filter(i => i.status === 'completed')
                .reduce((sum, i) => sum + i.amount, 0);
            const pendingIncome = income.filter(i => i.status === 'pending')
                .reduce((sum, i) => sum + i.amount, 0);
            
            // Group income by source
            const incomeBySource = {};
            income.forEach(item => {
                incomeBySource[item.source] = (incomeBySource[item.source] || 0) + item.amount;
            });
            
            // Format modal content
            modalBody.innerHTML = `
                <h4 class="mb-3">${event.title} - Income Details</h4>
                
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card bg-primary text-white">
                            <div class="card-body">
                                <h5>Total Income</h5>
                                <h3>₹${totalEventIncome.toLocaleString()}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-success text-white">
                            <div class="card-body">
                                <h5>Completed</h5>
                                <h3>₹${completedIncome.toLocaleString()}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-warning text-white">
                            <div class="card-body">
                                <h5>Pending</h5>
                                <h3>₹${pendingIncome.toLocaleString()}</h3>
                            </div>
                        </div>
                    </div>
                </div>
                
                <h5 class="mb-3">Income by Source</h5>
                <div class="table-responsive mb-4">
                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Source</th>
                                <th>Amount</th>
                                <th>Percentage</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(incomeBySource).map(([source, amount]) => `
                                <tr>
                                    <td>${source.charAt(0).toUpperCase() + source.slice(1)}</td>
                                    <td>₹${amount.toLocaleString()}</td>
                                    <td>${((amount / totalEventIncome) * 100).toFixed(1)}%</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                
                <h5 class="mb-3">Income Transactions</h5>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Date</th>
                                <th>Source</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${income.map(i => `
                                <tr>
                                    <td>${new Date(i.date).toLocaleDateString()}</td>
                                    <td>${i.source.charAt(0).toUpperCase() + i.source.slice(1)}</td>
                                    <td>₹${i.amount.toLocaleString()}</td>
                                    <td><span class="badge bg-${i.status === 'completed' ? 'success' : 'warning'}">${i.status}</span></td>
                                    <td>${i.description || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            modal.show();
        }

        // Initialize income tracking
        document.addEventListener('DOMContentLoaded', function() {
            // Add sample income data if none exists
            if (DataStore.income.length === 0) {
                console.log("Adding sample income data...");
                
                // Function to generate unique IDs
                function generateId() {
                    return 'id_' + Math.random().toString(36).substr(2, 9);
                }
                
                const events = DataStore.events;
                if (events.length > 0) {
                    // Add income entries for each event
                    events.forEach(event => {
                        // Calculate registration income based on participants
                        const participants = DataStore.registrations.filter(r => r.eventId === event._id);
                        
                        // Add registration income for participants
                        participants.forEach(participant => {
                            DataStore.addIncome({
                                _id: generateId(),
                                eventId: event._id,
                                amount: event.entryFee,
                                source: 'registration',
                                status: Math.random() > 0.2 ? 'completed' : 'pending', // 80% completed, 20% pending
                                description: `Registration fee for ${participant.name}`,
                                date: participant.registrationDate || new Date().toISOString()
                            });
                        });
                        
                        // Add sponsorship income (for some events)
                        if (Math.random() > 0.4) {
                            const sponsorshipAmount = Math.floor(Math.random() * 5 + 1) * 5000; // Random amount between 5000-25000
                            DataStore.addIncome({
                                _id: generateId(),
                                eventId: event._id,
                                amount: sponsorshipAmount,
                                source: 'sponsorship',
                                status: 'completed',
                                description: 'Corporate sponsorship',
                                date: new Date(new Date().setDate(new Date().getDate() - Math.floor(Math.random() * 30))).toISOString()
                            });
                        }
                        
                        // Add merchandise income (for some events)
                        if (Math.random() > 0.6) {
                            const merchandiseAmount = Math.floor(Math.random() * 10 + 1) * 500; // Random amount between 500-5000
                            DataStore.addIncome({
                                _id: generateId(),
                                eventId: event._id,
                                amount: merchandiseAmount,
                                source: 'merchandise',
                                status: 'completed',
                                description: 'T-shirt and merchandise sales',
                                date: new Date(new Date().setDate(new Date().getDate() - Math.floor(Math.random() * 15))).toISOString()
                            });
                        }
                        
                        // Add donation income (for some events)
                        if (Math.random() > 0.7) {
                            const donationAmount = Math.floor(Math.random() * 20 + 1) * 100; // Random amount between 100-2000
                            DataStore.addIncome({
                                _id: generateId(),
                                eventId: event._id,
                                amount: donationAmount,
                                source: 'donation',
                                status: Math.random() > 0.5 ? 'completed' : 'pending',
                                description: 'Voluntary donations',
                                date: new Date(new Date().setDate(new Date().getDate() - Math.floor(Math.random() * 10))).toISOString()
                            });
                        }
                    });
                    
                    console.log("Sample income data added!");
                }
            }

            // Initialize income tracking
            const incomeEventFilter = document.getElementById('incomeEventFilter');
            incomeEventFilter.innerHTML = '<option value="all">All Events</option>';
            
            DataStore.events.forEach(event => {
                const option = document.createElement('option');
                option.value = event._id;
                option.textContent = event.title;
                incomeEventFilter.appendChild(option);
            });

            // Add event listener for income filter
            incomeEventFilter.addEventListener('change', function() {
                updateIncomeDisplay();
            });

            // Add income tab to navigation if it doesn't exist
            if (!document.querySelector('a[href="#income"]')) {
                const financeNavItem = document.querySelector('a[href="#finance"]').parentNode;
                const incomeNavItem = document.createElement('div');
                incomeNavItem.className = 'nav-item';
                incomeNavItem.innerHTML = `
                    <a href="#income" class="nav-link" data-section="income">
                        <i class="fas fa-money-bill-wave"></i> Income Tracking
                    </a>
                `;
                financeNavItem.after(incomeNavItem);
            }

            // Add income section click handler
            document.querySelector('a[href="#income"]').addEventListener('click', function() {
                updateIncomeDisplay();
            });

            // Initial update of income display
            updateIncomeDisplay();
        });

        // Function to refresh income data
        function refreshIncomeData() {
            // Check for new registrations that might affect income
            DataStore.loadFromStorage();
            updateIncomeDisplay();
            showToast('Income data refreshed!', 'success');
        }

        // Function to generate unique IDs
        function generateId() {
            return 'id_' + Math.random().toString(36).substr(2, 9);
        }

        // Function to add sample income data
        function addSampleIncomeData() {
            const events = DataStore.events;
            if (events.length === 0) return;
            
            // Define income sources
            const sources = ['registration', 'sponsorship', 'donation', 'merchandise', 'other'];
            const statuses = ['completed', 'pending'];
            
            // Add income entries for each event
            events.forEach(event => {
                // Calculate registration income based on participants
                const participants = DataStore.registrations.filter(r => r.eventId === event._id);
                
                // Add registration income for participants
                participants.forEach(participant => {
                    DataStore.addIncome({
                        _id: generateId(),
                        eventId: event._id,
                        amount: event.entryFee,
                        source: 'registration',
                        status: Math.random() > 0.2 ? 'completed' : 'pending', // 80% completed, 20% pending
                        description: `Registration fee for ${participant.name}`,
                        date: participant.registrationDate || new Date().toISOString()
                    });
                });
                
                // Add sponsorship income (for some events)
                if (Math.random() > 0.4) {
                    const sponsorshipAmount = Math.floor(Math.random() * 5 + 1) * 5000; // Random amount between 5000-25000
                    DataStore.addIncome({
                        _id: generateId(),
                        eventId: event._id,
                        amount: sponsorshipAmount,
                        source: 'sponsorship',
                        status: 'completed',
                        description: 'Corporate sponsorship',
                        date: new Date(new Date().setDate(new Date().getDate() - Math.floor(Math.random() * 30))).toISOString()
                    });
                }
                
                // Add merchandise income (for some events)
                if (Math.random() > 0.6) {
                    const merchandiseAmount = Math.floor(Math.random() * 10 + 1) * 500; // Random amount between 500-5000
                    DataStore.addIncome({
                        _id: generateId(),
                        eventId: event._id,
                        amount: merchandiseAmount,
                        source: 'merchandise',
                        status: 'completed',
                        description: 'T-shirt and merchandise sales',
                        date: new Date(new Date().setDate(new Date().getDate() - Math.floor(Math.random() * 15))).toISOString()
                    });
                }
                
                // Add donation income (for some events)
                if (Math.random() > 0.7) {
                    const donationAmount = Math.floor(Math.random() * 20 + 1) * 100; // Random amount between 100-2000
                    DataStore.addIncome({
                        _id: generateId(),
                        eventId: event._id,
                        amount: donationAmount,
                        source: 'donation',
                        status: Math.random() > 0.5 ? 'completed' : 'pending',
                        description: 'Voluntary donations',
                        date: new Date(new Date().setDate(new Date().getDate() - Math.floor(Math.random() * 10))).toISOString()
                    });
                }
            });
        }

        // Function to view participant details
        function viewParticipantDetails(participantId) {
            const participant = DataStore.participants.find(p => p._id === participantId);
            if (!participant) {
                showToast('Participant not found', 'error');
                return;
            }

            const event = DataStore.events.find(e => e._id === participant.eventId);
            if (!event) {
                showToast('Event not found', 'error');
                return;
            }

            const modal = new bootstrap.Modal(document.getElementById('participantDetailsModal'));
            const modalBody = document.getElementById('participantDetailsBody');
            
            modalBody.innerHTML = `
                <div class="participant-details">
                    <h4 class="mb-3">${event.title} - Participant Details</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="detail-group mb-3">
                                <label class="text-muted">Student Name</label>
                                <p class="mb-0">${participant.studentName}</p>
                            </div>
                            <div class="detail-group mb-3">
                                <label class="text-muted">Student ID</label>
                                <p class="mb-0">${participant.studentId}</p>
                            </div>
                            <div class="detail-group mb-3">
                                <label class="text-muted">Email</label>
                                <p class="mb-0">${participant.email}</p>
                            </div>
                            <div class="detail-group mb-3">
                                <label class="text-muted">Phone</label>
                                <p class="mb-0">${participant.phone}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="detail-group mb-3">
                                <label class="text-muted">Department</label>
                                <p class="mb-0">${participant.department}</p>
                            </div>
                            <div class="detail-group mb-3">
                                <label class="text-muted">Year</label>
                                <p class="mb-0">${participant.year}</p>
                            </div>
                            <div class="detail-group mb-3">
                                <label class="text-muted">Registration Date</label>
                                <p class="mb-0">${new Date(participant.registrationDate).toLocaleDateString()}</p>
                            </div>
                            <div class="detail-group mb-3">
                                <label class="text-muted">Status</label>
                                <p class="mb-0">
                                    <span class="badge bg-${participant.status === 'confirmed' ? 'success' : 'warning'}">
                                        ${participant.status}
                                    </span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            modal.show();
        }

        // Add Income Button Click Handler
        document.getElementById('addIncomeBtn').addEventListener('click', function() {
            // Populate event dropdown
            const eventSelect = document.getElementById('incomeEventSelect');
            eventSelect.innerHTML = '<option value="">Select Event</option>';
            
            DataStore.events.forEach(event => {
                const option = document.createElement('option');
                option.value = event._id;
                option.textContent = event.title;
                eventSelect.appendChild(option);
            });
            
            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('addIncomeModal'));
            modal.show();
        });
        
        // Add Income Form Submit Handler
        document.getElementById('addIncomeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const incomeData = {
                _id: generateId(),
                eventId: formData.get('eventId'),
                amount: parseFloat(formData.get('amount')),
                source: formData.get('source'),
                status: formData.get('status'),
                description: formData.get('description') || '',
                date: new Date().toISOString()
            };
            
            // Add the income to DataStore
            DataStore.addIncome(incomeData);
            
            // Reset the form and close the modal
            this.reset();
            bootstrap.Modal.getInstance(document.getElementById('addIncomeModal')).hide();
            
            // Update display and show success message
            updateIncomeDisplay();
            showToast('Income added successfully!', 'success');
        });

        // Initialize event listeners and UI components
        function initializeApp() {
            // ... existing code ...
            
            // Add some sample income data if none exists
            addSampleIncomeData();
        }

        // Add sample income data on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Check if income data exists
            if (DataStore.income.length === 0) {
                console.log("Adding sample income data...");
                
                // Function to generate unique IDs
                function generateId() {
                    return 'id_' + Math.random().toString(36).substr(2, 9);
                }
                
                const events = DataStore.events;
                if (events.length === 0) return;
                
                // Add income entries for each event
                events.forEach(event => {
                    // Calculate registration income based on participants
                    const participants = DataStore.registrations.filter(r => r.eventId === event._id);
                    
                    // Add registration income for participants
                    participants.forEach(participant => {
                        DataStore.addIncome({
                            _id: generateId(),
                            eventId: event._id,
                            amount: event.entryFee,
                            source: 'registration',
                            status: Math.random() > 0.2 ? 'completed' : 'pending', // 80% completed, 20% pending
                            description: `Registration fee for ${participant.name}`,
                            date: participant.registrationDate || new Date().toISOString()
                        });
                    });
                    
                    // Add sponsorship income (for some events)
                    if (Math.random() > 0.4) {
                        const sponsorshipAmount = Math.floor(Math.random() * 5 + 1) * 5000; // Random amount between 5000-25000
                        DataStore.addIncome({
                            _id: generateId(),
                            eventId: event._id,
                            amount: sponsorshipAmount,
                            source: 'sponsorship',
                            status: 'completed',
                            description: 'Corporate sponsorship',
                            date: new Date(new Date().setDate(new Date().getDate() - Math.floor(Math.random() * 30))).toISOString()
                        });
                    }
                    
                    // Add merchandise income (for some events)
                    if (Math.random() > 0.6) {
                        const merchandiseAmount = Math.floor(Math.random() * 10 + 1) * 500; // Random amount between 500-5000
                        DataStore.addIncome({
                            _id: generateId(),
                            eventId: event._id,
                            amount: merchandiseAmount,
                            source: 'merchandise',
                            status: 'completed',
                            description: 'T-shirt and merchandise sales',
                            date: new Date(new Date().setDate(new Date().getDate() - Math.floor(Math.random() * 15))).toISOString()
                        });
                    }
                    
                    // Add donation income (for some events)
                    if (Math.random() > 0.7) {
                        const donationAmount = Math.floor(Math.random() * 20 + 1) * 100; // Random amount between 100-2000
                        DataStore.addIncome({
                            _id: generateId(),
                            eventId: event._id,
                            amount: donationAmount,
                            source: 'donation',
                            status: Math.random() > 0.5 ? 'completed' : 'pending',
                            description: 'Voluntary donations',
                            date: new Date(new Date().setDate(new Date().getDate() - Math.floor(Math.random() * 10))).toISOString()
                        });
                    }
                });
                
                // Refresh the income display
                updateIncomeDisplay();
                console.log("Sample income data added!");
            }
        });

        // Update dashboard overview statistics
        function updateDashboardStats() {
            // Get events data
            const events = DataStore.events;
            const totalEvents = events.length;
            
            // Get current month data
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();
            
            // Calculate new events this month
            const newEventsThisMonth = events.filter(event => {
                const eventDate = new Date(event.date);
                return eventDate.getMonth() === currentMonth && 
                       eventDate.getFullYear() === currentYear;
            }).length;
            
            // Get registration data
            const registrations = DataStore.registrations;
            const totalParticipants = registrations.length;
            
            // Calculate new participants this month
            const newParticipantsThisMonth = registrations.filter(reg => {
                const regDate = new Date(reg.registrationDate);
                return regDate.getMonth() === currentMonth && 
                       regDate.getFullYear() === currentYear;
            }).length;
            
            // Calculate total revenue from income
            const income = DataStore.income;
            const totalRevenue = income.reduce((sum, item) => sum + item.amount, 0);
            
            // Calculate new revenue this month
            const newRevenueThisMonth = income.filter(item => {
                const itemDate = new Date(item.date);
                return itemDate.getMonth() === currentMonth && 
                       itemDate.getFullYear() === currentYear;
            }).reduce((sum, item) => sum + item.amount, 0);
            
            // Update the DOM
            document.getElementById('totalEvents').textContent = totalEvents;
            document.getElementById('newEvents').textContent = `${newEventsThisMonth} this month`;
            
            document.getElementById('totalParticipants').textContent = totalParticipants;
            document.getElementById('newParticipants').textContent = `${newParticipantsThisMonth} this month`;
            
            document.getElementById('totalRevenue').textContent = `₹${totalRevenue.toLocaleString()}`;
            document.getElementById('newRevenue').textContent = `₹${newRevenueThisMonth.toLocaleString()} this month`;
            
            // Also update the Recent Events table with the latest events
            updateRecentEvents(events);
        }
        
        // Update recent events table
        function updateRecentEvents(allEvents) {
            // Sort events by date (most recent first) and take top 5
            const recentEvents = [...allEvents]
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);
                
            // Get the events table in the dashboard section specifically
            const dashboardTbody = document.querySelector('#dashboard #eventsTableBody');
            
            if (!dashboardTbody) return; // If the table doesn't exist, exit
            
            dashboardTbody.innerHTML = recentEvents.map(event => {
                const stats = DataStore.calculateEventStats(event._id);
                
                // Calculate income for this event
                const eventIncome = DataStore.calculateEventIncome(event._id);
                
                return `
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                ${event.photo ? `
                                    <img src="${event.photo}" alt="${event.title}" class="rounded me-2" style="width: 40px; height: 40px; object-fit: cover;">
                                ` : `
                                    <div class="rounded me-2" style="width: 40px; height: 40px; background: #f0f0f0; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-calendar-alt text-muted"></i>
                                    </div>
                                `}
                                <span>${event.title}</span>
                            </div>
                        </td>
                        <td>${new Date(event.date).toLocaleDateString()}</td>
                        <td>${stats.confirmedParticipants}/${stats.totalCapacity}</td>
                        <td>₹${event.budget.toLocaleString()}</td>
                        <td>
                            <div class="d-flex flex-column">
                                <span class="mb-1">₹${eventIncome.toLocaleString()}</span>
                                <div class="progress" style="height: 5px;">
                                    <div class="progress-bar bg-success" role="progressbar" 
                                        style="width: ${stats.collectionPercentage}%" 
                                        aria-valuenow="${stats.collectionPercentage}" 
                                        aria-valuemin="0" 
                                        aria-valuemax="100">
                                    </div>
                                </div>
                                <small class="text-muted">${stats.collectionPercentage.toFixed(1)}% collected</small>
                            </div>
                        </td>
                        <td><span class="badge bg-success">${event.status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-primary me-2" onclick="editEvent('${event._id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteEvent('${event._id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Update registration display
        function updateRegistrationDisplay(registrations) {
            const eventSelect = document.getElementById('eventSelect');
            const selectedEvent = eventSelect.value;
            
            if (selectedEvent) {
                const eventRegistrations = registrations.filter(r => r.eventId === selectedEvent);
                populateParticipantsList(eventRegistrations);
            }
        }
    </script>

    <!-- Add Income Details Modal -->
    <div class="modal fade" id="incomeDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Income Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="incomeDetailsBody">
                    <!-- Income details will be dynamically loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Participant Details Modal -->
    <div class="modal fade" id="participantDetailsModal" tabindex="-1" aria-labelledby="participantDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="participantDetailsModalLabel">Participant Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="participantDetailsBody">
                    <!-- Content will be dynamically loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Income Modal -->
    <div class="modal fade" id="addIncomeModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Income</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addIncomeForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Event</label>
                                <select class="form-select" name="eventId" id="incomeEventSelect" required>
                                    <option value="">Select Event</option>
                                    <!-- Events will be loaded dynamically -->
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Amount (₹)</label>
                                <input type="number" class="form-control" name="amount" min="1" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Source</label>
                                <select class="form-select" name="source" required>
                                    <option value="registration">Registration Fee</option>
                                    <option value="sponsorship">Sponsorship</option>
                                    <option value="donation">Donation</option>
                                    <option value="merchandise">Merchandise</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Payment Status</label>
                                <select class="form-select" name="status" required>
                                    <option value="completed">Completed</option>
                                    <option value="pending">Pending</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" name="description" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end mt-4">
                            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-success">Add Income</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</body>
</html> 